<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>tank</title>
        <meta name="description" content="">
        <meta name="format-detection" content="telephone-no">
        <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width, minimal-ui">
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="format-detection" content="telephone=no">
    </head>
    <body>
        <script src="./lib/pixi.min.js"></script>
        <script src="./lib/victor.min.js"></script>
        <script src="./lib/require.js"></script>

        <!-- require modules -->
        <script>
        require.register("./modules/config", function(module, exports, require) {
            var Config =
            {
                "world": {
                    "map": {
                        "w": 2048,
                        "h": 2048,
                        "color": 0x808080
                    },
                    "view": {
                        "w": 600,
                        "h": 800
                    },
                    "grid": {
                        "size": 32,
                        "edge": 1,
                        "color": 0xa0a0a0
                    },
                    "walkable": {
                        "x": 128,
                        "y": 128,
                        "w": 1792,
                        "h": 1792,
                        "color": 0xcdcdcd
                    },
                    "updateMS": 1000 / 30
                },
            
                "bullets": {
                    "normal": {
                        "edge": {
                            "w": 2,
                            "color": 0x555555
                        },
                        "body": {
                            "radius": 10,
                            "color": 0x00b2e1
                        },
                        "speed": 10,
                    }
                },
            
                "tanks": {
                    "normal": {
                        "edge": {
                            "w": 2.5,
                            "color": 0x555555
                        },
                        "body": {
                            "radius": 30,
                            "color": 0x00b2e1
                        },
                        "weapons": [
                            {
                                "w": 15,
                                "h": 50,
                                "x": -10,
                                "y": 0,
                                "bullet": "normal",
                                "angle": 0,
                                "color": 0x999999,
                                "shootOffset": 10,
                                "reloadFrame": 10,
                                "shootDelayFrame": 3
                            },
                            {
                                "w": 15,
                                "h": 50,
                                "x": 10,
                                "y": 0,
                                "bullet": "normal",
                                "angle": 0,
                                "color": 0x999999,
                                "shootOffset": 10,
                                "reloadFrame": 10,
                                "shootDelayFrame": 6
                            }
                        ],
                        "speed": 5,
                    }
                }
            };
            
            module.exports = Config;
        });
        </script>
        <script>
        require.register("./modules/bullet", function(module, exports, require) {
            var Config = require("../modules/config");
            
            var _id = 1;
            
            function Bullet(world, position, angle, weapon)
            {
                this._id = _id ++;
                this._world = world;
                this._owner = weapon.owner;
                this._angle = angle;
            
                this._cfg = Config.bullets[weapon.cfg.bullet];
                this._speed = this._cfg.speed;
            
                var graphics = new PIXI.Graphics();
                graphics.lineStyle(this._cfg.edge.w, this._cfg.edge.color);
                graphics.beginFill(this._cfg.body.color);
                graphics.drawCircle(0, 0, this._cfg.body.radius);
                graphics.endFill();
                this._sprite = new PIXI.Sprite(graphics.generateTexture());
                graphics.destroy();
            
                this._sprite.anchor.x = 0.5;
                this._sprite.anchor.y = 0.5;
                this._sprite.position.x = position.x;
                this._sprite.position.y = position.y;
                world.view.addChild(this._sprite);
            }
            
            Bullet.prototype = {}
            
            Bullet.prototype.update = function()
            {
                // update bullet position
                if (this._sprite.position.x < 0
                    || this._sprite.position.x > Config.world.map.w
                    || this._sprite.position.y < 0
                    || this._sprite.position.y > Config.world.map.h) {
                    return -1;
                }
                this._sprite.position.x += this._speed * Math.cos(this._angle);
                this._sprite.position.y += this._speed * Math.sin(this._angle);
                return 0;
            }
            
            Object.defineProperties(Bullet.prototype, {
            
                id : {
                    get: function() { return this._id; }
                },
            
                world: {
                    get: function() { return this._world; }
                },
            
                owner: {
                    get: function() { return this._owner; }
                },
            
                cfg: {
                    get: function() { return this._cfg; }
                },
            
                sprite: {
                    get: function() { return this._sprite; }
                },
            
                speed: {
                    get: function() { return this._speed; }
                },
            
                angle: {
                    get: function() { return this._angle; }
                },
            
                x: {
                    get: function() { return this._sprite.x; },
                    set: function(v) { this._sprite.x = v; }
                },
            
                y: {
                    get: function() { return this._sprite.y; },
                    set: function(v) { this._sprite.y = v; }
                },
            });
            
            module.exports = Bullet;
            
        });
        </script>
        <script>
        require.register("./modules/tank", function(module, exports, require) {
            var Config = require("../modules/config");
            var Weapon = require("../modules/weapon");
            
            function tankHandleKeyDown(tank)
            {
                document.body.addEventListener('keydown', function(e) {
                    switch (e.key) {
                        case 'w':
                        case 'W':
                            tank.moveDir.y -= 1;
                            if (tank.moveDir.y < -1) {
                                tank.moveDir.y = -1;
                            }
                            break;
                        case 'd':
                        case 'D':
                            tank.moveDir.x += 1;
                            if (tank.moveDir.x > 1) {
                                tank.moveDir.x = 1;
                            }
                            break;
                        case 's':
                        case 'S':
                            tank.moveDir.y += 1;
                            if (tank.moveDir.y > 1) {
                                tank.moveDir.y = 1;
                            }
                            break;
                        case 'a':
                        case 'A':
                            tank.moveDir.x -= 1;
                            if (tank.moveDir.x < -1) {
                                tank.moveDir.x = -1;
                            }
                            break;
                    }
                }, false);
            }
            
            function tankHandleKeyUp(tank)
            {
                document.body.addEventListener('keyup', function(e) {
                    switch (e.key) {
                        case 'w':
                        case 'W':
                            tank.moveDir.y += 1;
                            if (tank.moveDir.y > 1) {
                                tank.moveDir.y = 1;
                            }
                            break;
                        case 'd':
                        case 'D':
                            tank.moveDir.x -= 1;
                            if (tank.moveDir.x < -1) {
                                tank.moveDir.x = -1;
                            }
                            break;
                        case 's':
                        case 'S':
                            tank.moveDir.y -= 1;
                            if (tank.moveDir.y < -1) {
                                tank.moveDir.y = -1;
                            }
                            break;
                        case 'a':
                        case 'A':
                            tank.moveDir.x += 1;
                            if (tank.moveDir.x > 1) {
                                tank.moveDir.x = 1;
                            }
                            break;
                    }
                }, false);
            }
            
            function tankHandleMouseMove(tank)
            {
                document.body.addEventListener('mousemove', function(e) {
                    var targetPos = new Victor(e.x - tank.world.view.x, e.y - tank.world.view.y);
                    var dir = targetPos.subtract(tank.sprite.position);
                    // TODO: rotate speed
                    tank.sprite.rotation = dir.angle() + Math.PI / 2;
                }, false);
            }
            
            function tankHandleMouseDown(tank) {
                document.body.addEventListener('mousedown', function(e) {
                    tank.fire();
                }, false);
            }
            
            function Tank(world, name)
            {
                this._world = world;
                this._cfg = Config.tanks[name];
                this._autoFire = true;
                this._moveDir = new Victor(0, 0);
            
                this._sprite = new PIXI.Container();
                this._weapons = [];
                for (var idx in this._cfg.weapons) {
                    this._weapons.push(new Weapon(world, this, this._cfg.weapons[idx]));
                }
            
                var graphics = new PIXI.Graphics();
                graphics.lineStyle(this._cfg.edge.w, this._cfg.edge.color);
                graphics.beginFill(this._cfg.body.color);
                graphics.drawCircle(0, 0, this._cfg.body.radius);
                graphics.endFill();
                var bodySprite = new PIXI.Sprite(graphics.generateTexture());
                bodySprite.anchor.x = 0.5;
                bodySprite.anchor.y = 0.5;
                this._sprite.addChild(bodySprite);
                graphics.destroy();
            
                // born position
                this._sprite.x = Config.world.map.w / 2;
                this._sprite.y = Config.world.map.h / 2;
            
                // event handlers:
                tankHandleKeyDown(this);
                tankHandleKeyUp(this);
                tankHandleMouseMove(this);
                tankHandleMouseDown(this);
            
                world.view.addChild(this._sprite);
            }
            
            Tank.prototype = {}
            
            Tank.prototype.update = function()
            {
                // update tank position
                if (this._moveDir.lengthSq() > 1e-6) {
                    var angle = this._moveDir.angle();
                    this.y += this.cfg.speed * Math.sin(angle);
                    this.x += this.cfg.speed * Math.cos(angle);
                    // clamp
                    var cfg = Config.world.walkable;
                    if (this.x > cfg.x + cfg.w) {
                        this.x = cfg.x + cfg.w;
                    }
                    if (this.x < cfg.x) {
                        this.x = cfg.x;
                    }
                    if (this.y > cfg.y + cfg.h) {
                        this.y = cfg.y + cfg.h;
                    }
                    if (this.y < cfg.y) {
                        this.y = cfg.y;
                    }
                }
            
                // fire
                if (this.autoFire == true) {
                    this.fire();
                }
            }
            
            Tank.prototype.fire = function()
            {
                for (var idx in this.weapons) {
                    this.weapons[idx].fire();
                }
            }
            
            Object.defineProperties(Tank.prototype, {
            
                world: {
                    get: function() { return this._world; }
                },
            
                cfg: {
                    get: function() { return this._cfg; }
                },
            
                sprite: {
                    get: function() { return this._sprite; }
                },
            
                x: {
                    get: function() { return this._sprite.x; },
                    set: function(v) { this._sprite.x = v; }
                },
                y: {
                    get: function() { return this._sprite.y; },
                    set: function(v) { this._sprite.y = v; }
                },
            
                autoFire: {
                    get: function() { return this._autoFire; },
                    set: function(v) { this._autoFire = v; }
                },
            
                moveDir: {
                    get: function() { return this._moveDir; }
                },
            
                weapons: {
                    get: function() { return this._weapons; }
                },
            });
            
            module.exports = Tank;
            
        });
        </script>
        <script>
        require.register("./modules/weapon", function(module, exports, require) {
            var Bullet = require("../modules/bullet");
            
            function weaponCreateView(weapon)
            {
            }
            
            function Weapon(world, tank, cfg)
            {
                this._world = world;
                this._owner = tank;
                this._cfg = cfg;
                this._angle = this._cfg.angle;
                this._offset = new Victor(0, - this._cfg.shootOffset - this._cfg.h);
                this._offset.rotateDeg(this._cfg.angle)
                           .add(new Victor(this._cfg.x, this._cfg.y));
                this._fireFrame = world.frame + this._cfg.shootDelayFrame;
            
                var graphics = new PIXI.Graphics();
                graphics.lineStyle(this._owner.cfg.edge.w, this._owner.cfg.edge.color);
                graphics.beginFill(this._cfg.color);
                graphics.drawRect(0, 0, this._cfg.w, this._cfg.h);
                graphics.endFill();
                var weaponSprite = new PIXI.Sprite(graphics.generateTexture());
                weaponSprite.anchor.x = 0.5;
                weaponSprite.anchor.y = 1.0;
                weaponSprite.rotation = this._cfg.angle * Math.PI / 180;
                weaponSprite.x += this._cfg.x;
                weaponSprite.y += this._cfg.y;
                tank.sprite.addChild(weaponSprite);
                graphics.destroy();
            }
            
            Weapon.prototype = {}
            
            Weapon.prototype.fire = function()
            {
                if (this._world.frame - this._fireFrame >= this._cfg.reloadFrame) {
            
                    this._fireFrame = this._world.frame;
            
                    var pos = this._offset.clone();
                    pos.rotate(this._owner.sprite.rotation);
                    pos.add(new Victor(this._owner.sprite.position.x, this._owner.sprite.position.y));
                    var angle = this._owner.sprite.rotation + this._cfg.angle * Math.PI / 180 - Math.PI / 2;
                    var bullet = new Bullet(this._world, pos, angle, this);
                    this._world.bullets.push(bullet);
                }
            }
            
            Object.defineProperties(Weapon.prototype, {
            
                world: {
                    get: function() { return this._world; }
                },
            
                owner: {
                    get: function() { return this._owner; }
                },
            
                cfg: {
                    get: function() { return this._cfg; }
                },
            
                angle: {
                    get: function() { return this._angle; }
                },
            
                offset: {
                    get: function() { return this._offset; }
                },
            });
            
            module.exports = Weapon;
            
        });
        </script>
        <script>
        require.register("./modules/world", function(module, exports, require) {
            var Config = require("../modules/config");
            var Tank = require("../modules/tank");
            
            function getWorldBackground()
            {
                var cfg = Config.world;
                var graphics = new PIXI.Graphics();
            
                // background walkable region
                graphics.beginFill(cfg.walkable.color);
                graphics.drawRect(cfg.walkable.x, cfg.walkable.y,
                    cfg.walkable.w, cfg.walkable.h);
                graphics.endFill();
            
                // background grids
                graphics.lineStyle(cfg.grid.edge, cfg.grid.color);
                for (var x = cfg.grid.size; x < cfg.map.w; x += cfg.grid.size) {
                    graphics.moveTo(x, 0);
                    graphics.lineTo(x, cfg.map.h);
                }
                for (var y = cfg.grid.size; y < cfg.map.h; y += cfg.grid.size) {
                    graphics.moveTo(0, y);
                    graphics.lineTo(cfg.map.w, y);
                }
            
                return graphics;
            }
            
            function World()
            {
                this._frame = 0;
            
                var dateTime = new Date();
                this._ms = dateTime.getTime();
            
                this._stage = new PIXI.Container();
            
                // main view (camera bind)
                this._view = new PIXI.Container();
                this._view.addChild(getWorldBackground());
                this._stage.addChild(this._view);
            
                // UI & HUD
                this._ui = new PIXI.Container();
                this._stage.addChild(this._ui);
            
                this._renderer = new PIXI.CanvasRenderer(Config.world.view.w, Config.world.view.h, {
                        backgroundColor: Config.world.map.color,
                        antialias: true,
                        autoResize: true,
                    });
                document.body.appendChild(this._renderer.view);
            
                // world objects
                this._bullets = [];
                this._tank = new Tank(this, "normal");
            }
            
            World.prototype = {};
            World.prototype.constructor = World;
            
            World.prototype._updateCamera = function()
            {
                var x = this._tank.sprite.position.x;
                var y = this._tank.sprite.position.y;
                var viewCenterX = Config.world.view.w / 2;
                var viewCenterY = Config.world.view.h / 2;
                if (x < viewCenterX) {
                    x = viewCenterX;
                }
                if (x > Config.world.map.w - viewCenterX) {
                    x = Config.world.map.w - viewCenterX;
                }
                if (y < viewCenterY) {
                    y = viewCenterY;
                }
                if (y > Config.world.map.h - viewCenterY) {
                    y = Config.world.map.h - viewCenterY;
                }
                this._view.x = viewCenterX - x;
                this._view.y = viewCenterY - y;
            }
            
            World.prototype._updateLogic = function()
            {
                var dateTime = new Date();
                var ms = dateTime.getTime();
            
                while (ms > this._ms + Config.world.updateMS) {
            
                    this._ms += Config.world.updateMS;
                    this._frame ++;
            
                    if (this._tank) {
                        this._tank.update();
                    }
            
                    for (var i in this._bullets) {
                        var bullet = this._bullets[i];
                        if (bullet.update() < 0) {
                            var idx = this._view.getChildIndex(bullet.sprite);
                            this._bullets.splice(i, 1);
                            this._view.removeChildAt(idx);
                            delete bullet;
                        }
                    }
                }
            }
            
            World.prototype.update = function()
            {
                this._updateLogic();
                this._updateCamera();
                this._renderer.render(this._stage);
            }
            
            Object.defineProperties(World.prototype, {
            
                frame: {
                    get: function () { return this._frame; }
                },
            
                view: {
                    get: function() { return this._view; }
                },
            
                ui: {
                    get: function() { return this._ui; }
                },
            
                bullets: {
                    get: function() { return this._bullets; }
                },
            
                tank: {
                    get: function() { return this._tank; }
                }
            });
            
            module.exports = World;
            
        });
        </script>

        <script src="./main.js"></script>
    </body>
</html>
