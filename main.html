<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>tank</title>
        <meta name="description" content="">
        <meta name="format-detection" content="telephone-no">
        <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width, minimal-ui">
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="format-detection" content="telephone=no">
    </head>
    <body>
        <script src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
        <script src="./lib/pixi.min.js"></script>
        <script src="./lib/victor.min.js"></script>
        <script src="./lib/require.js"></script>

        <!-- require modules -->
        <script>
        require.register("./modules/config", function(module, exports, require) {
            var Config = {
            
                "world": {
                    "w": 768,
                    "h": 1024,
                    "color": 0xcdcdcd
                },
            
                // 239 73 84
                "bullet": {
                    "edge": {
                        "w": 2.5,
                        "color": 0x555555
                    },
                    "body": {
                        "radius": 10,
                        "color": 0x00b2e1
                    },
                    "speed": 10,
                },
            
                "tank": {
                    "edge": {
                        "w": 2.5,
                        "color": 0x555555
                    },
                    "body": {
                        "radius": 30,
                        "color": 0x00b2e1
                    },
                    "weapons": [
                        {
                            "w": 20,
                            "h": 55,
                            "x": -10,
                            "y": -55,
                            "angle": 0,
                            "color": 0x999999,
                            "shootOffsetX": 0,
                            "shootOffsetY": -20,
                        }
                    ],
                    "speed": 3,
                }
            };
            
            module.exports = Config;
        });
        </script>
        <script>
        require.register("./modules/view", function(module, exports, require) {
            var Config = require("../modules/config");
            
            var View = {};
            
            View.spawnTank = function() {
                var graphics = new PIXI.Graphics();
                graphics.lineStyle(Config.tank.edge.w, Config.tank.edge.color);
                for (var i in Config.tank.weapons) {
                    var weapon = Config.tank.weapons[i];
                    graphics.beginFill(weapon.color);
                    // TODO: angle
                    graphics.drawRect(weapon.x, weapon.y, weapon.w, weapon.h);
                }
                graphics.beginFill(Config.tank.body.color);
                graphics.drawCircle(0, 0, Config.tank.body.radius);
                graphics.endFill();
                var tank = new PIXI.Sprite(graphics.generateTexture());
                tank.anchor.x = (Config.tank.body.radius + Config.tank.edge.w) / tank.width;
                tank.anchor.y = (weapon.h + Config.tank.edge.w) / tank.height;
            
                // custom property
                tank.weapons = [];
                for (var i in Config.tank.weapons) {
                    var weapon = Config.tank.weapons[i];
                    tank.weapons[i] = {};
                    var offsetX = -weapon.w / 2 - weapon.x + weapon.shootOffsetX;
                    var offsetY = -weapon.h + weapon.shootOffsetY;
                    tank.weapons[i].offset = new Victor(offsetX, offsetY);
                }
                graphics.destroy();
                return tank;
            }
            
            View.spawnBullet = function() {
                var graphics = new PIXI.Graphics();
                graphics.lineStyle(Config.bullet.edge.w, Config.bullet.edge.color);
                graphics.beginFill(Config.bullet.body.color);
                graphics.drawCircle(0, 0, Config.bullet.body.radius);
                graphics.endFill();
                var bullet = new PIXI.Sprite(graphics.generateTexture());
                bullet.anchor.x = 0.5;
                bullet.anchor.y = 0.5;
                graphics.destroy();
                return bullet;
            }
            
            module.exports = View;
        });
        </script>
        <script>
        require.register("./modules/bullet", function(module, exports, require) {
            var Config = require("../modules/config");
            var View = require('../modules/view');
            
            var _id = 1;
            
            function bulletUpdate() {
                // update bullet position
                this.sprite.position.x += Config.bullet.speed * Math.cos(this.angle);
                this.sprite.position.y += Config.bullet.speed * Math.sin(this.angle);
                if (this.sprite.position.x < 0
                    || this.sprite.position.x > Config.world.w
                    || this.sprite.position.y < 0
                    || this.sprite.position.y > Config.world.h) {
                    return -1;
                }
                return 0;
            }
            
            function Bullet(stage, position, angle, tank) {
                this.id = _id ++;
                this.owner = tank;
                this.angle = angle;
                this.sprite = View.spawnBullet();
                this.sprite.position.x = position.x;
                this.sprite.position.y = position.y;
                this.update = bulletUpdate;
                stage.addChild(this.sprite);
            }
            
            module.exports = Bullet;
            
        });
        </script>
        <script>
        require.register("./modules/tank", function(module, exports, require) {
            var Bullet = require("../modules/bullet");
            var Config = require("../modules/config");
            var View = require('../modules/view');
            
            function tankHandleKeyDown(tank) {
                document.body.addEventListener('keydown', function(e) {
                    switch (e.key) {
                        case 'w':
                        case 'W':
                            tank.moveDir.y -= 1;
                            if (tank.moveDir.y < -1) {
                                tank.moveDir.y = -1;
                            }
                            break;
                        case 'd':
                        case 'D':
                            tank.moveDir.x += 1;
                            if (tank.moveDir.x > 1) {
                                tank.moveDir.x = 1;
                            }
                            break;
                        case 's':
                        case 'S':
                            tank.moveDir.y += 1;
                            if (tank.moveDir.y > 1) {
                                tank.moveDir.y = 1;
                            }
                            break;
                        case 'a':
                        case 'A':
                            tank.moveDir.x -= 1;
                            if (tank.moveDir.x < -1) {
                                tank.moveDir.x = -1;
                            }
                            break;
                    }
                }, false);
            }
            
            function tankHandleKeyUp(tank) {
                document.body.addEventListener('keyup', function(e) {
                    switch (e.key) {
                        case 'w':
                        case 'W':
                            tank.moveDir.y += 1;
                            if (tank.moveDir.y > 1) {
                                tank.moveDir.y = 1;
                            }
                            break;
                        case 'd':
                        case 'D':
                            tank.moveDir.x -= 1;
                            if (tank.moveDir.x < -1) {
                                tank.moveDir.x = -1;
                            }
                            break;
                        case 's':
                        case 'S':
                            tank.moveDir.y -= 1;
                            if (tank.moveDir.y < -1) {
                                tank.moveDir.y = -1;
                            }
                            break;
                        case 'a':
                        case 'A':
                            tank.moveDir.x += 1;
                            if (tank.moveDir.x > 1) {
                                tank.moveDir.x = 1;
                            }
                            break;
                    }
                }, false);
            }
            
            function tankHandleMouseMove(tank) {
                document.body.addEventListener('mousemove', function(e) {
                    tank.targetPos.x = e.x;
                    tank.targetPos.y = e.y;
                }, false);
            }
            
            function tankHandleMouseDown(tank) {
                document.body.addEventListener('mousedown', function(e) {
                    tank.fire();
                }, false);
            }
            
            function tankUpdate() {
                // update tank position
                if (this.moveDir.lengthSq() > 1e-6) {
                    var angle = this.moveDir.angle();
                    this.sprite.position.x += Config.tank.speed * Math.cos(angle);
                    this.sprite.position.y += Config.tank.speed * Math.sin(angle);
                }
                // update tank weapon direction
                if (this.targetPos.lengthSq() > 1e-6) {
                    var dir = this.targetPos.clone().subtract(this.sprite.position);
                    this.sprite.rotation = dir.angle() + Math.PI / 2;
                }
            }
            
            function tankFire() {
                var pos = this.sprite.weapons[0].offset.clone();
                pos.rotate(this.sprite.rotation);
                pos.add(new Victor(this.sprite.position.x, this.sprite.position.y));
                var bullet = new Bullet(this.stage, pos, this.sprite.rotation - Math.PI / 2, this);
                self.world.bullets.push(bullet);
            }
            
            function Tank(world, stage, isPlayer) {
                this.world = world;
                this.isPlayer = isPlayer;
                this.stage = stage;
                this.sprite = View.spawnTank();
                this.sprite.position.x = Config.world.w / 2;
                this.sprite.position.y = Config.world.h / 2;
                this.moveDir = new Victor(0, 0);
                this.targetPos = new Victor(0, 0);
                this.update = tankUpdate;
                this.fire = tankFire;
                if (isPlayer == true) {
                    tankHandleKeyDown(this);
                    tankHandleKeyUp(this);
                    tankHandleMouseMove(this);
                    tankHandleMouseDown(this);
                }
                stage.addChild(this.sprite);
            }
            
            module.exports = Tank;
            
        });
        </script>

        <script src="./main.js"></script>
    </body>
</html>
