<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>tank</title>
        <meta name="description" content="">
        <meta name="format-detection" content="telephone-no">
        <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width, minimal-ui">
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="format-detection" content="telephone=no">
    </head>
    <body>
        <script src="./lib/bytebuffer.min.js"></script>
        <script src="./lib/long.min.js"></script>
        <script src="./lib/pixi.min.js"></script>
        <script src="./lib/protobuf-light.min.js"></script>
        <script src="./lib/require.js"></script>
        <script src="./lib/victor.min.js"></script>

        <!-- require modules -->
        <script>
        require.register("../cfg/configBullets", function(module, exports, require) {
            var configBullets={0:{density:1,hp:1,damage:10,alias:"normal",radius:8,duration:900,velocity:{ivMax:300,ivDec:50,evMax:100,springBase:30,rv:0,ivMin:200,springAdd:10,ivAcc:200,ivInit:300,evDec:80},view:{body:{color:"0xf14e54",playerColor:"0x00b2e1",radius:7},edge:{color:"0x555555",w:2}}}};module.exports=configBullets;
        });
        </script>
        <script>
        require.register("../cfg/configDieAnimation", function(module, exports, require) {
            var configDieAnimation={0:{scaleIncrease:.1,alias:"base",alphaStart:.4,alphaEnd:.1,alphaDecrease:.1}};module.exports=configDieAnimation;
        });
        </script>
        <script>
        require.register("../cfg/configHpbar", function(module, exports, require) {
            var configHpbar={0:{alias:"base",view:{color:"0x86c680",h:20,edge:{color:"0x555555",w:4},radius:10,w:100,alpha:.75}}};module.exports=configHpbar;
        });
        </script>
        <script>
        require.register("../cfg/configObstacles", function(module, exports, require) {
            var configObstacles={0:{density:1,hp:20,damage:2,alias:"triangle",radius:20,velocity:{ivMax:3,ivDec:0,evMax:120,springBase:30,rv:.5,ivMin:3,springAdd:10,ivAcc:0,ivInit:3,evDec:80},view:{color:"0xfc7676",hpbar:{scaleYRatio:.6,scaleXRatio:.6,yOffsetRatio:1.4,xOffsetRatio:0},edge:{color:"0x555555",w:2.5},radius:20,side:3}},1:{density:1,hp:40,damage:4,alias:"quad",radius:20,velocity:{ivMax:3,ivDec:0,evMax:100,springBase:30,rv:.5,ivMin:3,springAdd:10,ivAcc:0,ivInit:3,evDec:80},view:{color:"0xffe869",hpbar:{scaleYRatio:.6,scaleXRatio:.6,yOffsetRatio:1.4,xOffsetRatio:0},edge:{color:"0x555555",w:2.5},radius:20,side:4}},2:{density:1,hp:80,damage:8,alias:"pentagon",radius:24,velocity:{ivMax:3,ivDec:0,evMax:80,springBase:30,rv:.5,ivMin:3,springAdd:10,ivAcc:0,ivInit:3,evDec:80},view:{color:"0x768dfc",hpbar:{scaleYRatio:.6,scaleXRatio:.6,yOffsetRatio:1.4,xOffsetRatio:0},edge:{color:"0x555555",w:2.5},radius:24,side:5}}};module.exports=configObstacles;
        });
        </script>
        <script>
        require.register("../cfg/configTanks", function(module, exports, require) {
            var configTanks={0:{density:1,hp:200,damage:10,weapons:{1:"",0:"base",3:"",2:""},alias:"base",radius:24,velocity:{ivMax:160,ivDec:200,evMax:120,springBase:30,rv:0,ivMin:0,springAdd:10,ivAcc:400,ivInit:0,evDec:80},view:{body:{color:"0xf14e54",playerColor:"0x00b2e1",radius:22},hpbar:{scaleYRatio:.6,scaleXRatio:.6,yOffsetRatio:1.4,xOffsetRatio:0},edge:{color:"0x555555",w:2.5}}},1:{density:1,hp:300,damage:10,weapons:{1:"twin-right",0:"twin-left",3:"",2:""},alias:"twin",radius:26,velocity:{ivMax:160,ivDec:200,evMax:120,springBase:30,rv:0,ivMin:0,springAdd:10,ivAcc:400,ivInit:0,evDec:80},view:{body:{color:"0xf14e54",playerColor:"0x00b2e1",radius:24},hpbar:{scaleYRatio:.6,scaleXRatio:.6,yOffsetRatio:1.4,xOffsetRatio:0},edge:{color:"0x555555",w:2.5}}},2:{density:1,hp:400,damage:10,weapons:{1:"quad-right",0:"quad-up",3:"quad-left",2:"quad-down"},alias:"quad",radius:26,velocity:{ivMax:160,ivDec:200,evMax:120,springBase:30,rv:0,ivMin:0,springAdd:10,ivAcc:400,ivInit:0,evDec:80},view:{body:{color:"0xf14e54",playerColor:"0x00b2e1",radius:24},hpbar:{scaleYRatio:.6,scaleXRatio:.6,yOffsetRatio:1.4,xOffsetRatio:0},edge:{color:"0x555555",w:2.5}}}};module.exports=configTanks;
        });
        </script>
        <script>
        require.register("../cfg/configWeapons", function(module, exports, require) {
            var configWeapons={0:{disturbDeg:15,fireAnimDistance:5,angle:0,bullet:"normal",shootOffset:45,alias:"base",fireAnimFrame:16,recoil:1e4,reloadFrame:10,y:0,x:0,shootDelayFrame:3,view:{color:"0x999999",h:35,edge:{color:"0x555555",w:2},w:15}},1:{disturbDeg:15,fireAnimDistance:5,angle:0,bullet:"normal",shootOffset:50,alias:"twin-left",fireAnimFrame:16,recoil:8e3,reloadFrame:10,y:0,x:-8,shootDelayFrame:3,view:{color:"0x999999",h:40,edge:{color:"0x555555",w:2},w:12}},2:{disturbDeg:15,fireAnimDistance:5,angle:0,bullet:"normal",shootOffset:50,alias:"twin-right",fireAnimFrame:16,recoil:8e3,reloadFrame:10,y:0,x:8,shootDelayFrame:6,view:{color:"0x999999",h:40,edge:{color:"0x555555",w:2},w:12}},3:{disturbDeg:15,fireAnimDistance:5,angle:0,bullet:"normal",shootOffset:48,alias:"quad-up",fireAnimFrame:16,recoil:1e4,reloadFrame:10,y:0,x:0,shootDelayFrame:3,view:{color:"0x999999",h:38,edge:{color:"0x555555",w:2},w:16}},4:{disturbDeg:15,fireAnimDistance:5,angle:90,bullet:"normal",shootOffset:48,alias:"quad-right",fireAnimFrame:16,recoil:1e4,reloadFrame:10,y:0,x:0,shootDelayFrame:6,view:{color:"0x999999",h:38,edge:{color:"0x555555",w:2},w:16}},5:{disturbDeg:15,fireAnimDistance:5,angle:180,bullet:"normal",shootOffset:48,alias:"quad-down",fireAnimFrame:16,recoil:1e4,reloadFrame:10,y:0,x:0,shootDelayFrame:3,view:{color:"0x999999",h:38,edge:{color:"0x555555",w:2},w:16}},6:{disturbDeg:15,fireAnimDistance:5,angle:270,bullet:"normal",shootOffset:48,alias:"quad-left",fireAnimFrame:16,recoil:1e4,reloadFrame:10,y:0,x:0,shootDelayFrame:6,view:{color:"0x999999",h:38,edge:{color:"0x555555",w:2},w:16}}};module.exports=configWeapons;
        });
        </script>
        <script>
        require.register("../cfg/configMap", function(module, exports, require) {
            var configMap={0:{color:"0x808080",h:2048,obstacleRegion:{color:"0xcdcdcd",wRatio:.92,hRatio:.92},w:2048,view:{grid:{color:"0xa0a0a0",edge:1,size:32}}}};module.exports=configMap;
        });
        </script>
        <script>
        require.register("../cfg/configWorld", function(module, exports, require) {
            var configWorld={0:{maxObstaclesCount:50,frame:30,gridSize:128,unitCollideCheckMS:500}};module.exports=configWorld;
        });
        </script>

        <script>
        require.register("../modules/config", function(module, exports, require) {
            function Config(){this.configBullets={};for(var i in configBullets)this.configBullets[configBullets[i].alias]=configBullets[i];this.configDieAnimation={};for(var i in configDieAnimation)this.configDieAnimation[configDieAnimation[i].alias]=configDieAnimation[i];this.configHpbar={};for(var i in configHpbar)this.configHpbar[configHpbar[i].alias]=configHpbar[i];this.configObstacles={};for(var i in configObstacles)this.configObstacles[configObstacles[i].alias]=configObstacles[i];this.configTanks={};for(var i in configTanks)this.configTanks[configTanks[i].alias]=configTanks[i];this.configWeapons={};for(var i in configWeapons)this.configWeapons[configWeapons[i].alias]=configWeapons[i];this.configMap=configMap[0],this.configWorld=configWorld[0]}var configBullets=require("../cfg/configBullets"),configDieAnimation=require("../cfg/configDieAnimation"),configHpbar=require("../cfg/configHpbar"),configObstacles=require("../cfg/configObstacles"),configTanks=require("../cfg/configTanks"),configWeapons=require("../cfg/configWeapons"),configMap=require("../cfg/configMap"),configWorld=require("../cfg/configWorld");module.exports=Config;
        });
        </script>
        <script>
        require.register("../modules/bullet", function(module, exports, require) {
            function Bullet(t,e,l,i,o){this.owner=i.owner,this.bornTime=t.time,Unit.call(this,t,Util.unitType.bullet,t.cfg.configBullets[i.cfg.bullet],e,l,o)}var Unit=require("../modules/unit"),Util=require("../modules/util");Bullet.prototype=Object.create(Unit.prototype),Bullet.prototype.constructor=Bullet,Bullet.prototype.outOfDate=function(){return this.world.time>this.bornTime+this.cfg.duration},module.exports=Bullet;
        });
        </script>
        <script>
        require.register("../modules/hpbar", function(module, exports, require) {
            function HpBar(i,t,e,s){this.world=i,this.type=Util.unitType.hpbar,this.cfg=i.cfg.configHpbar[t],this.owner=e,this.display=s,this.percent=1,this.view=new View(this),this.x=this.view.x,this.y=this.view.y,this.rotation=0}var Util=require("../modules/util"),View=require("../modules/view");HpBar.prototype={constructor:HpBar},HpBar.prototype.die=function(){this.view.onDie()},HpBar.prototype.update=function(i){Math.abs(i-1)<1e-6&&this.display===!1?this.view.visible=!1:this.view.visible=!0,this.percent!=i&&(this.view.updateHpbar(this.percent,i),this.percent=i),this.view.update()},Object.defineProperties(HpBar.prototype,{}),module.exports=HpBar;
        });
        </script>
        <script>
        require.register("../modules/motion", function(module, exports, require) {
            function Motion(i,t,o){this.owner=i,this.cfg=t,this.moveDir=new Victor(0,0),this.iv=new Victor(t.ivInit*Math.cos(o),t.ivInit*Math.sin(o)),this.ev=new Victor(0,0),this.rv=t.rv}var Util=require("../modules/util"),epsilon=1e-6;Motion.prototype={constructor:Motion},Motion.prototype.toString=function(){return"unit["+this.owner.id+"] move dir={"+this.moveDir.x+","+this.moveDir.y+"} iv={"+this.iv.x+","+this.iv.y+"} ev={"+this.ev.x+","+this.ev.y+"} v="+this.v},Motion.prototype.randomMoveDir=function(){var i=Math.random()*Math.PI*2;this.moveDir.x=Math.cos(i),this.moveDir.y=Math.sin(i)},Motion.prototype.setMoveDirByAngle=function(i){this.moveDir.x=Math.cos(i),this.moveDir.y=Math.sin(i)},Motion.prototype.setMoveDirByFlag=function(i,t,o,e){this.moveDir.x=0,this.moveDir.y=0,1==i&&(this.moveDir.x-=1),1==t&&(this.moveDir.x+=1),1==o&&(this.moveDir.y-=1),1==e&&(this.moveDir.y+=1)},Motion.prototype.reverseIvX=function(){this.iv.x=-this.iv.x},Motion.prototype.reverseIvY=function(){this.iv.y=-this.iv.y},Motion.prototype.addRecoil=function(i,t){this.ev.x-=i*Math.cos(t),this.ev.y-=i*Math.sin(t)},Motion.prototype.update=function(i){var t=this.iv.length();if(t>this.cfg.ivMin){var o=this.cfg.ivDec*i/1e3;t=t>o?t-o:0,t=t<this.cfg.ivMin?this.cfg.ivMin:t,this.iv.norm().multiply(new Victor(t,t))}if(this.moveDir.length()>epsilon){var e=this.moveDir.angle();this.iv.x+=this.cfg.ivAcc*Math.cos(e)*i/1e3,this.iv.y+=this.cfg.ivAcc*Math.sin(e)*i/1e3;var t=this.iv.length();t>this.cfg.ivMax&&(t=this.cfg.ivMax,this.iv.norm().multiply(new Victor(t,t)))}var s=this.ev.length();if(s>epsilon){var o=this.cfg.evDec*i/1e3;s=s>o?s-o:0,s=s>this.cfg.evMax?this.cfg.evMax:s,this.ev.norm().multiply(new Victor(s,s))}this.owner.x+=(this.iv.x+this.ev.x)*i/1e3,this.owner.y+=(this.iv.y+this.ev.y)*i/1e3,Util.clampPosition(this.owner,0,this.owner.world.w,0,this.owner.world.h),null!=this.rv&&Math.abs(this.rv)>epsilon&&(this.owner.rotation+=this.rv*i/1e3)},Object.defineProperties(Motion.prototype,{vx:{get:function(){return this.iv.x+this.ev.x}},vy:{get:function(){return this.iv.y+this.ev.y}},v:{get:function(){return Math.sqrt(this.vx*this.vx+this.vy*this.vy)}}}),module.exports=Motion;
        });
        </script>
        <script>
        require.register("../modules/obstacle", function(module, exports, require) {
            function Obstacle(t,e,o,i){Unit.call(this,t,Util.unitType.obstacle,t.cfg.configObstacles[e],o,Math.random()*Math.PI*2,i),i===!0&&Unit.prototype.addHpBar.call(this,"base",!1)}var Unit=require("../modules/unit"),Util=require("../modules/util");Obstacle.prototype=Object.create(Unit.prototype),Obstacle.prototype.constructor=Obstacle,Obstacle.prototype.update=function(){Unit.prototype.update.call(this),(this.x<this.world.spawnRegion.x||this.x>this.world.spawnRegion.x+this.world.spawnRegion.w)&&this.motion.reverseIvX(),(this.y<this.world.spawnRegion.y||this.y>this.world.spawnRegion.y+this.world.spawnRegion.h)&&this.motion.reverseIvY()},module.exports=Obstacle;
        });
        </script>
        <script>
        require.register("../modules/player", function(module, exports, require) {
            function Player(t,e){this.world=t,this.connid=e,this.tank=null,this.control={left:0,right:0,up:0,down:0}}var Tank=require("../modules/tank"),Util=require("../modules/util");Player.prototype={constructor:Player},Player.prototype.handleKeyDown=function(){var t=this;document.body.addEventListener("keydown",function(e){if(null!=t.tank)switch(e.keyCode){case 87:case 119:t.control.up=1;break;case 68:case 100:t.control.right=1;break;case 83:case 115:t.control.down=1;break;case 65:case 97:t.control.left=1}},!1)},Player.prototype.handleKeyUp=function(){var t=this;document.body.addEventListener("keyup",function(e){if(null!=t.tank)switch(e.keyCode){case 87:case 119:t.control.up=0;break;case 68:case 100:t.control.right=0;break;case 83:case 115:t.control.down=0;break;case 65:case 97:t.control.left=0}},!1)},Player.prototype.handleMouseMove=function(){var t=this;document.body.addEventListener("mousemove",function(e){var o=new Victor(e.offsetX-t.world.view.x,e.offsetY-t.world.view.y);if(null!=t.tank){var n=o.subtract(new Victor(t.tank.x,t.tank.y));t.tank.rotation=n.angle()+Math.PI/2}},!1)},Player.prototype.handleMouseDown=function(){var t=this;document.body.addEventListener("mousedown",function(e){null!=t.tank&&t.tank.revertFireStatus()},!1)},Player.prototype.addControl=function(){this.world.view&&(this.handleKeyDown(),this.handleKeyUp(),this.handleMouseMove(),this.handleMouseDown())},Player.prototype.resetControl=function(){this.control.left=0,this.control.right=0,this.control.up=0,this.control.down=0},Player.prototype.update=function(){if(this.tank)this.tank.motion.setMoveDirByFlag(this.control.left,this.control.right,this.control.up,this.control.down);else{var t=document.documentElement.clientWidth,e=document.documentElement.clientHeight-10,o=(this.world.w-t)/2,n=(this.world.h-e)/2;this.tank=new Tank(this.world,"base",{x:Math.random()*o+t/2,y:Math.random()*n+e/2},this,!!this.world.view),this.world.tanks[this.tank.id]=this.tank,this.resetControl()}},Object.defineProperties(Player.prototype,{x:{get:function(){return this.tank?this.tank.x:0}},y:{get:function(){return this.tank?this.tank.y:0}}}),module.exports=Player;
        });
        </script>
        <script>
        require.register("../modules/synchronizer", function(module, exports, require) {
            function Synchronizer(o){this.world=o,this.pb=dcodeIO.ProtoBuf}Synchronizer.prototype={constructor:Synchronizer},Synchronizer.prototype.registProtocol=function(o){this.builder=this.pb.loadJsonFile(o),this.proto=this.builder.build("Tank")},Synchronizer.prototype.syncUnit=function(o){var t=new this.proto.Unit;t.id=o.id,t.type=o.type,t.cfgName=o.cfg.alias,t.hp=o.hp,t.motion=new this.proto.Motion,t.motion.moveDir=new this.proto.Vector(o.motion.moveDir.x,o.motion.moveDir.y),t.motion.iv=new this.proto.Vector(o.motion.iv.x,o.motion.iv.y),t.motion.ev=new this.proto.Vector(o.motion.ev.x,o.motion.ev.y),t.motion.rv=o.motion.rv,t.motion.position=new this.proto.Vector(o.x,o.y),t.motion.rotation=o.rotation;var i=new this.proto.Pkg;i.head=new this.proto.Head,i.head.frame=this.world.frame,i.head.cmd=this.proto.SyncCmd.SYNC_UNITS,i.body=new this.proto.Body,i.body.syncUnits=new this.proto.SyncUnits,i.body.syncUnits.units=[],i.body.syncUnits.units.push(t);var n=i.encode();console.log(n.toArrayBuffer())},module.exports=Synchronizer;
        });
        </script>
        <script>
        require.register("../modules/tank", function(module, exports, require) {
            function Tank(t,e,i,o,a){this.player=o,this.weapons=[];var n=t.cfg.configTanks[e];for(var r in n.weapons)if(""!=n.weapons[r]){var s=new Weapon(t,this,n.weapons[r],a);this.weapons.push(s)}Unit.call(this,t,Util.unitType.tank,n,i,0,a),a===!0&&Unit.prototype.addHpBar.call(this,"base",!0)}var Weapon=require("../modules/weapon"),Unit=require("../modules/unit"),Util=require("../modules/util");Tank.prototype=Object.create(Unit.prototype),Tank.prototype.constructor=Tank,Tank.prototype.update=function(){Unit.prototype.update.call(this),this.autoFire===!0&&this.fire();for(var t in this.weapons)this.weapons[t].update()},Tank.prototype.fire=function(){for(var t in this.weapons)this.weapons[t].fire()},Tank.prototype.revertFireStatus=function(){if(this.autoFire===!0)this.autoFire=!1;else{this.autoFire=!0;for(var t in this.weapons)this.weapons[t].resetFireDelay()}},module.exports=Tank;
        });
        </script>
        <script>
        require.register("../modules/weapon", function(module, exports, require) {
            function Weapon(i,t,e,r){this.world=i,this.type=Util.unitType.weapon,this.owner=t,this.cfg=i.cfg.configWeapons[e],this.fireFrame=i.frame+this.cfg.shootDelayFrame,r===!0&&(this.view=new View(this)),this.offset=new Victor(0,-this.cfg.shootOffset),this.offset.rotateDeg(this.cfg.angle).add(new Victor(this.cfg.x,this.cfg.y)),this.rotation=this.cfg.angle*Math.PI/180,this.x=this.cfg.x,this.y=this.cfg.y,this.fireAnimFrame=null,this.originalX=this.x,this.originalY=this.y}var Bullet=require("../modules/bullet"),Util=require("../modules/util"),View=require("../modules/view");Weapon.prototype={constructor:Weapon},Weapon.prototype.resetFireDelay=function(){this.fireFrame=this.world.frame+this.cfg.shootDelayFrame},Weapon.prototype.update=function(){if(this.fireAnimFrame){var i=this.world.frame-this.fireAnimFrame;if(i>this.cfg.fireAnimFrame)this.fireAnimFrame=null;else{var t=Math.abs(i/this.cfg.fireAnimFrame*2-1)*this.cfg.fireAnimDistance;this.x=this.originalX+Math.cos(this.rotation+Math.PI/2)*t,this.y=this.originalY+Math.sin(this.rotation+Math.PI/2)*t}}this.view&&this.view.update()},Weapon.prototype.fire=function(){if(this.world.frame-this.fireFrame>=this.cfg.reloadFrame){this.fireFrame=this.world.frame,this.fireAnimFrame=this.world.frame;var i=this.offset.clone();if(i.rotate(this.owner.rotation),i.add(new Victor(this.owner.x,this.owner.y)),i.x<=0||i.y<=0||i.x>=this.world.w||i.y>=this.world.h)return;var t=this.owner.rotation+this.cfg.angle*Math.PI/180-Math.PI/2,e=this.cfg.disturbDeg*Math.PI/180,r=t+(Math.random()*e-e/2),s=new Bullet(this.world,i,r,this,!!this.view);this.world.bullets[s.id]=s;var o=this.cfg.recoil/this.owner.m;this.owner.motion.addRecoil(o,t)}},module.exports=Weapon;
        });
        </script>
        <script>
        require.register("../modules/world", function(module, exports, require) {
            function getWorldBackground(i){var t=i.cfg.configMap,e=new PIXI.Graphics;e.beginFill(t.obstacleRegion.color),e.drawRect(i.spawnRegion.x,i.spawnRegion.y,i.spawnRegion.w,i.spawnRegion.h),e.endFill(),e.lineStyle(t.view.grid.edge,t.view.grid.color);for(var r=t.view.grid.size;r<i.w;r+=t.view.grid.size)e.moveTo(r,0),e.lineTo(r,i.h);for(var o=t.view.grid.size;o<i.h;o+=t.view.grid.size)e.moveTo(0,o),e.lineTo(i.w,o);return e}function World(i){this.frame=0,this.cfg=new Config,this.w=this.cfg.configMap.w,this.h=this.cfg.configMap.h,this.spawnRegion={},this.spawnRegion.x=this.w*(1-this.cfg.configMap.obstacleRegion.wRatio)/2,this.spawnRegion.w=this.w*this.cfg.configMap.obstacleRegion.wRatio,this.spawnRegion.y=this.h*(1-this.cfg.configMap.obstacleRegion.hRatio)/2,this.spawnRegion.h=this.h*this.cfg.configMap.obstacleRegion.hRatio,this.gridSize=this.cfg.configWorld.gridSize,this.gridW=Math.floor(this.w/this.gridSize)+1,this.gridH=Math.floor(this.h/this.gridSize)+1,this.grids=[];for(var t=0;t<this.gridH;++t)for(var e=0;e<this.gridW;++e)this.grids.push({});var r=new Date;this.time=r.getTime(),i===!0&&(this.stage=new PIXI.Container,this.view=new PIXI.Container,this.view.addChild(getWorldBackground(this)),this.stage.addChild(this.view),this.ui=new PIXI.Container,this.stage.addChild(this.ui),this.viewW=document.documentElement.clientWidth,this.viewH=document.documentElement.clientHeight-10,this.renderer=new PIXI.CanvasRenderer(this.viewW,this.viewH,{backgroundColor:Number(this.cfg.configMap.color),antialias:!0,autoResize:!0}),document.body.appendChild(this.renderer.view)),this.bullets={},this.obstacles={},this.obstacleCount=0,this.tanks={};var o=0;for(var t in this.cfg.configTanks){var s=new Tank(this,t,{x:this.w/2+200*o,y:this.h/2+200*o},null,!!this.view);s.autoFire=!0,this.tanks[s.id]=s,++o}this.player=new Player(this),i===!0&&this.player.addControl(),this.dieSprites=[],this.removeUnits=[],this.gameend=!1,this.synchronizer=new Synchronizer(this),i===!0?this.synchronizer.registProtocol("./tank.proto.json"):this.synchronizer.registProtocol("../proto/tank.proto.json")}var Config=require("../modules/config"),Obstacle=require("../modules/obstacle"),Player=require("../modules/player"),Synchronizer=require("../modules/synchronizer"),Tank=require("../modules/tank"),Util=require("../modules/util");World.prototype={constructor:World},World.prototype.updateCamera=function(){if(null!=this.view){var i=this.player.x,t=this.player.y,e=this.viewW/2,r=this.viewH/2;i=Util.clamp(i,e,this.w-e),t=Util.clamp(t,r,this.h-r),this.view.x=e-i,this.view.y=r-t}},World.prototype.updateTanks=function(){for(var i in this.tanks){var t=this.tanks[i],e=t.x,r=t.y;t.update(),this.updateUnitGrid(t,{x:e,y:r})}},World.prototype.updatePlayers=function(){this.player.update()},World.prototype.updateObstacles=function(){if(this.obstacleCount<this.cfg.configWorld.maxObstaclesCount){var i=["triangle","quad","pentagon"],t=i[Math.floor(Math.random()*i.length)],e=new Obstacle(this,t,{x:Util.randomBetween(this.spawnRegion.x,this.spawnRegion.x+this.spawnRegion.w),y:Util.randomBetween(this.spawnRegion.y,this.spawnRegion.y+this.spawnRegion.h)},!!this.view);this.obstacles[e.id]=e,this.obstacleCount++}for(var r in this.obstacles){var e=this.obstacles[r],o=e.x,s=e.y;e.update(),this.updateUnitGrid(e,{x:o,y:s})}},World.prototype.updateBullets=function(){for(var i in this.bullets){var t=this.bullets[i];if(t.outOfDate()||t.outOfBounds())t.die();else{var e=t.x,r=t.y;t.update(),this.updateUnitGrid(t,{x:e,y:r})}}},World.prototype.getUnitsIn9Grids=function(i,t){var e=[],r=[(t-1)*this.gridW+i-1,(t-1)*this.gridW+i,(t-1)*this.gridW+i+1,t*this.gridW+i-1,t*this.gridW+i,t*this.gridW+i+1,(t+1)*this.gridW+i-1,(t+1)*this.gridW+i,(t+1)*this.gridW+i+1],o=i>=1,s=i<this.gridW-1,n=t>=1,a=t<this.gridH-1;if(n&&o){var h=this.grids[r[0]];for(var d in h)e.push(h[d])}if(n){var h=this.grids[r[1]];for(var d in h)e.push(h[d])}if(n&&s){var h=this.grids[r[2]];for(var d in h)e.push(h[d])}if(o){var h=this.grids[r[3]];for(var d in h)e.push(h[d])}var h=this.grids[r[4]];for(var d in h)e.push(h[d]);if(s){var h=this.grids[r[5]];for(var d in h)e.push(h[d])}if(a&&o){var h=this.grids[r[6]];for(var d in h)e.push(h[d])}if(a){var h=this.grids[r[7]];for(var d in h)e.push(h[d])}if(a&&s){var h=this.grids[r[8]];for(var d in h)e.push(h[d])}return e},World.prototype.needCheckCollision=function(i,t){var e=null==i.owner?i:i.owner,r=null==t.owner?t:t.owner;return e!=r},World.prototype.elasticCollide=function(i,t){var e=new Victor(i.motion.vx,i.motion.vy),r=new Victor(t.motion.vx,t.motion.vy),o=((i.m-t.m)*e.x+2*t.m*r.x)/(i.m+t.m),s=((i.m-t.m)*e.y+2*t.m*r.y)/(i.m+t.m);i.motion.ev.x+=o,i.motion.ev.y+=s;var n=((t.m-i.m)*r.x+2*i.m*e.x)/(i.m+t.m),a=((t.m-i.m)*r.y+2*i.m*e.y)/(i.m+t.m);t.motion.ev.x+=n,t.motion.ev.y+=a},World.prototype.simpleCollide=function(i,t,e){var r=new Victor(i.x-t.x,i.y-t.y);r.norm();var o=i.motion.v,s=t.motion.v,n=t.cfg.velocity.springBase+(1-e)*t.cfg.velocity.springAdd,a=i.cfg.velocity.springBase+(1-e)*i.cfg.velocity.springAdd;i.motion.ev.x+=(s+n)*r.x*t.m/i.m,i.motion.ev.y+=(s+n)*r.y*t.m/i.m,t.motion.ev.x-=(o+a)*r.x*i.m/t.m,t.motion.ev.y-=(o+a)*r.y*i.m/t.m},World.prototype.collide=function(i,t,e){this.simpleCollide(i,t,e),i.takeDamageByUnit(t),t.takeDamageByUnit(i)},World.prototype.updateCollision=function(){for(var i=0;i<this.gridW;++i)for(var t=0;t<this.gridH;++t){var e=t*this.gridW+i;for(var r in this.grids[e]){var o=this.grids[e][r];if(!(null!=o.collideTime&&this.time-o.collideTime<this.cfg.configWorld.unitCollideCheckMS)){var s=this.getUnitsIn9Grids(i,t);for(var n in s){var a=s[n];if(o!=a&&this.needCheckCollision(o,a)!==!1&&a.collideCheckFrame!=this.frame){var h=o.x-a.x,d=o.y-a.y,l=o.radius+a.radius,g=h*h+d*d;g<l*l&&(o.collideTime=this.time,a.collideTime=this.time,this.collide(o,a,g/(l*l)))}}o.collideCheckFrame=this.frame}}}},World.prototype.updateDieAnimations=function(){if(null!=this.view){var i=this.cfg.configDieAnimation.base;for(var t in this.dieSprites){var e=this.dieSprites[t];e.alpha>i.alphaStart?e.alpha=i.alphaStart:e.alpha-=i.alphaDecrease,e.scale.x+=i.scaleIncrease,e.scale.y+=i.scaleIncrease,e.alpha<i.alphaEnd&&(e.parent&&e.parent.removeChild(e),this.dieSprites.splice(t,1),delete e)}}},World.prototype.updateLogic=function(){for(var i=new Date,t=i.getTime(),e=1e3/this.cfg.configWorld.frame;t>this.time+e;)this.time+=e,this.frame++,this.updatePlayers(),this.updateTanks(),this.updateObstacles(),this.updateBullets(),this.updateCollision(),this.updateDieAnimations()},World.prototype.updateUnitGrid=function(i,t){if(t.x!=i.x||t.y!=i.y){var e=Math.floor(t.x/this.gridSize),r=Math.floor(t.y/this.gridSize),o=r*this.gridW+e,s=Math.floor(i.x/this.gridSize),n=Math.floor(i.y/this.gridSize),a=n*this.gridW+s;a!=o&&delete this.grids[o][i.id],this.grids[a][i.id]=i}},World.prototype.removeUnitFromGrid=function(i){var t=Math.floor(i.x/this.gridSize),e=Math.floor(i.y/this.gridSize),r=e*this.gridW+t;delete this.grids[r][i.id]},World.prototype.addUnitToGrid=function(i){var t=Math.floor(i.x/this.gridSize),e=Math.floor(i.y/this.gridSize),r=e*this.gridW+t;this.grids[r][i.id]=i},World.prototype.update=function(){this.updateLogic(),this.view&&(this.updateCamera(),this.renderer.render(this.stage))},module.exports=World;
        });
        </script>
        <script>
        require.register("../modules/unit", function(module, exports, require) {
            function Unit(t,i,e,s,h,o){this.world=t,this.id=++id,this.type=i,this.cfg=e,this.motion=new Motion(this,this.cfg.velocity,h),o===!0&&(this.view=new View(this)),this.x=s.x,this.y=s.y,this.rotation=0,this.hp=this.cfg.hp,this.damage=this.cfg.damage,t.addUnitToGrid(this)}var HpBar=require("../modules/hpbar"),Motion=require("../modules/motion"),Util=require("../modules/util"),View=require("../modules/view"),id=0;Unit.prototype={constructor:Unit},Unit.prototype.addHpBar=function(t,i){this.hpbar&&delete this.hpbar,this.hpbar=new HpBar(this.world,t,this,i)},Unit.prototype.outOfBounds=function(){return this.x<=0||this.x>=this.world.w||this.y<=0||this.y>=this.world.h},Unit.prototype.takeDamageByUnit=function(t){this.hp-=t.damage,this.hp<=0&&this.die()},Unit.prototype.die=function(){this.hpbar&&this.hpbar.die(),this.view&&this.view.onDie(),this.world.removeUnitFromGrid(this),this.world.removeUnits.push(this),this.type==Util.unitType.bullet&&delete this.world.bullets[this.id],this.type==Util.unitType.obstacle&&(delete this.world.obstacles[this.id],--this.world.obstacleCount),this.type==Util.unitType.tank&&(delete this.world.tanks[this.id],this.world.player.tank==this&&(this.world.player.tank=null,this.world.gameend=!0,alert("Lose! Click To Restart!"),this.world.player.update()))},Unit.prototype.update=function(){var t=this.x,i=this.y,e=1e3/this.world.cfg.configWorld.frame;this.motion.update(e),this.view&&this.view.update(),this.hpbar&&(this.hpbar.x+=this.x-t,this.hpbar.y+=this.y-i,this.hpbar.update(this.hp/this.cfg.hp))},Object.defineProperties(Unit.prototype,{radius:{get:function(){return this.cfg.radius}},m:{get:function(){return this.radius*this.radius*this.cfg.density}}}),module.exports=Unit;
        });
        </script>
        <script>
        require.register("../modules/util", function(module, exports, require) {
            var Util={unitType:{tank:1,weapon:2,bullet:3,obstacle:4,hpbar:5},clamp:function(n,t,e){return n>e&&(n=e),n<t&&(n=t),n},clampPosition:function(n,t,e,o,a){n.x>e&&(n.x=e),n.x<t&&(n.x=t),n.y>a&&(n.y=a),n.y<o&&(n.y=o)},randomBetween:function(n,t){return Math.random()*(t-n)+n}};module.exports=Util;
        });
        </script>
        <script>
        require.register("../modules/view", function(module, exports, require) {
            function drawBullet(e){var t=new PIXI.Graphics;t.lineStyle(e.cfg.edge.w,e.cfg.edge.color),e.world.player.tank==e.owner.owner?t.beginFill(e.cfg.body.playerColor):t.beginFill(e.cfg.body.color),t.drawCircle(0,0,e.cfg.body.radius),t.endFill();var i=new PIXI.Sprite(t.generateTexture());t.destroy(),i.anchor.x=.5,i.anchor.y=.5,e.sprite.addChild(i),e.world.view.addChild(e.sprite)}function drawObstacle(e){var t=new PIXI.Graphics;t.lineStyle(e.cfg.edge.w,e.cfg.edge.color),t.beginFill(e.cfg.color);var i=new PIXI.Point(0,-e.cfg.radius);t.moveTo(i.x,i.y);for(var r=1;r<e.cfg.side;++r){var n=new Victor(i.x,i.y);n.rotate(2*Math.PI/e.cfg.side),t.lineTo(n.x,n.y),i.set(n.x,n.y),delete n}delete i,t.endFill();var o=new PIXI.Sprite(t.generateTexture());t.destroy(),o.pivot.x=o.width/2,o.pivot.y=e.cfg.radius+e.cfg.edge.w,e.sprite.addChild(o),e.world.view.addChild(e.sprite)}function drawWeapon(e){var t=new PIXI.Graphics;t.lineStyle(e.cfg.edge.w,e.cfg.edge.color),t.beginFill(e.cfg.color),t.drawRect(0,0,e.cfg.w,e.cfg.h),t.endFill();var i=new PIXI.Sprite(t.generateTexture());t.destroy(),i.anchor.x=.5,i.anchor.y=1,e.sprite.addChild(i)}function drawTank(e){for(var t in e.owner.weapons){var i=e.owner.weapons[t];e.sprite.addChild(i.view.sprite)}var r=new PIXI.Graphics;r.lineStyle(e.cfg.edge.w,e.cfg.edge.color),e.owner.player?r.beginFill(e.cfg.body.playerColor):r.beginFill(e.cfg.body.color),r.drawCircle(0,0,e.cfg.body.radius),r.endFill();var n=new PIXI.Sprite(r.generateTexture());r.destroy(),n.anchor.x=.5,n.anchor.y=.5,e.sprite.addChild(n),e.world.view.addChild(e.sprite)}function drawHpbar(e){var t=new PIXI.Graphics;t.lineStyle(e.cfg.edge.w,e.cfg.edge.color),t.beginFill(e.cfg.edge.color),t.drawRoundedRect(0,0,e.cfg.w,e.cfg.h,e.cfg.radius),t.endFill(),e.backSprite=new PIXI.Sprite(t.generateTexture()),e.backSprite.anchor.x=.5,e.backSprite.anchor.y=.5,t.lineStyle(e.cfg.edge.w,e.cfg.edge.color),t.beginFill(e.cfg.color),t.drawRoundedRect(0,0,e.cfg.w,e.cfg.h,e.cfg.radius),t.endFill(),e.frontSprite=new PIXI.Sprite(t.generateTexture()),e.frontSprite.anchor.x=.5,e.frontSprite.anchor.y=.5,e.sprite.addChild(e.backSprite),e.sprite.addChild(e.frontSprite),e.sprite.alpha=e.cfg.alpha;var i=e.owner.owner,r=2*i.radius,n=i.cfg.view;e.sprite.x=i.x+i.radius*n.hpbar.xOffsetRatio,e.sprite.y=i.y+i.radius*n.hpbar.yOffsetRatio,e.sprite.scale.x=n.hpbar.scaleXRatio*r/e.cfg.w,e.sprite.scale.y=n.hpbar.scaleYRatio*r/e.cfg.w,e.world.view.addChild(e.sprite)}function View(e){this.owner=e,this.cfg=this.owner.cfg.view,this.world=this.owner.world,this.sprite=new PIXI.Container,this.owner.type==Util.unitType.bullet?drawBullet(this):this.owner.type==Util.unitType.obstacle?drawObstacle(this):this.owner.type==Util.unitType.weapon?drawWeapon(this):this.owner.type==Util.unitType.tank?drawTank(this):this.owner.type==Util.unitType.hpbar&&drawHpbar(this)}var Util=require("../modules/util");View.prototype={constructor:View},View.prototype.onDie=function(){this.owner.type!=Util.unitType.bullet&&this.owner.type!=Util.unitType.obstacle&&this.owner.type!=Util.unitType.tank||this.world.dieSprites.push(this.sprite),this.owner.type==Util.unitType.hpbar&&(this.sprite.parent&&this.sprite.parent.removeChild(this.sprite),delete this.sprite)},View.prototype.update=function(){this.x=this.owner.x,this.y=this.owner.y,this.rotation=this.owner.rotation},View.prototype.updateHpbar=function(e,t){this.owner.type==Util.unitType.hpbar&&(this.frontSprite.x+=this.cfg.w*(1-e)/2,this.frontSprite.width=this.cfg.w*t,this.frontSprite.x-=this.cfg.w*(1-t)/2)},Object.defineProperties(View.prototype,{x:{get:function(){return this.sprite.x},set:function(e){this.sprite.x=e}},y:{get:function(){return this.sprite.y},set:function(e){this.sprite.y=e}},h:{get:function(){return this.sprite.height}},w:{get:function(){return this.sprite.width}},rotation:{get:function(){return this.sprite.rotation},set:function(e){this.sprite.rotation=e}},scale:{get:function(){return this.sprite.scale},set:function(e){this.sprite.scale=e}},visible:{get:function(){return this.sprite.visible},set:function(e){this.sprite.visible=e}}}),module.exports=View;
        });
        </script>

        <script src="./main.js"></script>
    </body>
</html>
